"""
Sprint Summary Chatbot - FastAPI Application
An interactive AI-powered chatbot for analyzing sprint data with visualizations.
"""

from fastapi import FastAPI, HTTPException, Request
from fastapi.responses import HTMLResponse, JSONResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import Optional, List, Dict, Any
import logging
import os

from config import settings
from data_analyzer import SprintDataAnalyzer
from agent import SprintAnalysisAgent

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Initialize FastAPI app
app = FastAPI(
    title="Sprint Summary Chatbot",
    description="AI-powered chatbot for sprint data analysis with interactive visualizations",
    version="1.0.0"
)

# Add CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Mount static files and templates
app.mount("/static", StaticFiles(directory="static"), name="static")
templates = Jinja2Templates(directory="templates")

# Initialize data analyzer and agent
data_analyzer = None
agent = None


@app.on_event("startup")
async def startup_event():
    """Initialize the data analyzer and agent on startup."""
    global data_analyzer, agent
    
    try:
        logger.info(f"Loading data from {settings.data_file}")
        data_analyzer = SprintDataAnalyzer(settings.data_file)
        
        logger.info(f"Initializing LangChain agent with {settings.llm_provider} provider")
        agent = SprintAnalysisAgent(data_analyzer)
        
        logger.info("Application startup complete")
    except Exception as e:
        logger.error(f"Error during startup: {str(e)}")
        raise


# Pydantic models
class ChatMessage(BaseModel):
    message: str


class ChatResponse(BaseModel):
    response: str
    charts: Optional[List[Dict[str, Any]]] = []
    timestamp: Optional[str] = None


class HealthResponse(BaseModel):
    status: str
    llm_provider: str
    data_loaded: bool
    total_tickets: int


@app.get("/", response_class=HTMLResponse)
async def root(request: Request):
    """Serve the main HTML page."""
    return templates.TemplateResponse("index.html", {"request": request})


@app.get("/health", response_model=HealthResponse)
async def health_check():
    """Health check endpoint."""
    return HealthResponse(
        status="healthy",
        llm_provider=settings.llm_provider,
        data_loaded=data_analyzer is not None,
        total_tickets=len(data_analyzer.df) if data_analyzer and data_analyzer.df is not None else 0
    )


@app.post("/chat", response_model=ChatResponse)
async def chat(message: ChatMessage):
    """
    Process a chat message and return AI response with optional charts.
    """
    if not agent:
        raise HTTPException(status_code=500, detail="Agent not initialized")
    
    try:
        logger.info(f"Processing message: {message.message}")
        
        result = agent.query(message.message)
        
        return ChatResponse(
            response=result["answer"],
            charts=result["charts"]
        )
    except Exception as e:
        logger.error(f"Error processing chat message: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))


@app.get("/api/summary")
async def get_summary():
    """Get overall data summary."""
    if not data_analyzer:
        raise HTTPException(status_code=500, detail="Data analyzer not initialized")
    
    return data_analyzer.get_data_summary()


@app.get("/api/sprint/{sprint_id}")
async def get_sprint(sprint_id: str):
    """Get specific sprint summary."""
    if not data_analyzer:
        raise HTTPException(status_code=500, detail="Data analyzer not initialized")
    
    return data_analyzer.get_sprint_summary(sprint_id)


@app.get("/api/team-performance")
async def get_team_performance():
    """Get team performance metrics."""
    if not data_analyzer:
        raise HTTPException(status_code=500, detail="Data analyzer not initialized")
    
    return data_analyzer.get_team_performance()


@app.get("/api/bugs")
async def get_bugs():
    """Get bug analysis."""
    if not data_analyzer:
        raise HTTPException(status_code=500, detail="Data analyzer not initialized")
    
    return data_analyzer.get_bug_analysis()


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        "app:app",
        host=settings.app_host,
        port=settings.app_port,
        reload=settings.debug
    )
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #f7fafc;
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 18px;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.bot .message-content {
            background: white;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .chart-container {
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .input-container {
            padding: 25px 30px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 15px;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        #message-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 15px;
            transition: all 0.3s ease;
            outline: none;
        }

        #message-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #send-button {
            padding: 15px 35px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }

        #send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        #send-button:active {
            transform: translateY(0);
        }

        #send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 15px 20px;
            background: white;
            border-radius: 18px;
            border: 1px solid #e2e8f0;
            width: fit-content;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #cbd5e0;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        .welcome-message h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .welcome-message p {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 25px;
        }

        .suggestion-chip {
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 20px;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .suggestion-chip:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .status-online {
            background: #d1fae5;
            color: #065f46;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Sprint Summary Chatbot</h1>
            <p>AI-powered sprint analytics with interactive visualizations</p>
        </div>
        
        <div class="chat-container" id="chat-container">
            <div class="welcome-message">
                <h2>üëã Welcome to Sprint Analytics!</h2>
                <p>Ask me anything about your sprint data, team performance, or request visualizations.</p>
                <div class="suggestions">
                    <div class="suggestion-chip" onclick="sendSuggestion('Show me overall sprint summary')">
                        üìä Sprint Summary
                    </div>
                    <div class="suggestion-chip" onclick="sendSuggestion('How is the team performing?')">
                        üë• Team Performance
                    </div>
                    <div class="suggestion-chip" onclick="sendSuggestion('Show me bug analysis')">
                        üêõ Bug Analysis
                    </div>
                    <div class="suggestion-chip" onclick="sendSuggestion('Create a velocity chart')">
                        üìà Velocity Chart
                    </div>
                </div>
            </div>
        </div>
        
        <div class="input-container">
            <div class="input-wrapper">
                <input 
                    type="text" 
                    id="message-input" 
                    placeholder="Ask about sprints, tickets, team performance..." 
                    autocomplete="off"
                />
            </div>
            <button id="send-button" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        // Handle Enter key
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function sendSuggestion(message) {
            messageInput.value = message;
            sendMessage();
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Clear input
            messageInput.value = '';
            
            // Remove welcome message if exists
            const welcomeMsg = chatContainer.querySelector('.welcome-message');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }

            // Add user message
            addMessage(message, 'user');

            // Show typing indicator
            const typingId = showTyping();

            // Disable input
            sendButton.disabled = true;
            messageInput.disabled = true;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();

                // Remove typing indicator
                removeTyping(typingId);

                // Add bot response
                addMessage(data.response, 'bot');

                // Add charts if any
                if (data.charts && data.charts.length > 0) {
                    data.charts.forEach((chart, index) => {
                        addChart(chart, `chart-${Date.now()}-${index}`);
                    });
                }
            } catch (error) {
                removeTyping(typingId);
                addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                console.error('Error:', error);
            } finally {
                // Re-enable input
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = text;
            
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typing-indicator';
            
            const typingContent = document.createElement('div');
            typingContent.className = 'typing-indicator';
            typingContent.innerHTML = '<span></span><span></span><span></span>';
            
            typingDiv.appendChild(typingContent);
            chatContainer.appendChild(typingDiv);
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return 'typing-indicator';
        }

        function removeTyping(id) {
            const typingElement = document.getElementById(id);
            if (typingElement) {
                typingElement.remove();
            }
        }

        function addChart(chartData, id) {
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.id = id;
            
            chatContainer.appendChild(chartDiv);
            
            // Render Plotly chart
            Plotly.newPlot(id, chartData.data, chartData.layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
            });
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Focus input on load
        window.addEventListener('load', () => {
            messageInput.focus();
        });
    </script>
</body>
</html>
    """


@app.get("/health", response_model=HealthResponse)
async def health_check():
    """Health check endpoint."""
    return HealthResponse(
        status="healthy",
        llm_provider=settings.llm_provider,
        data_loaded=data_analyzer is not None,
        total_tickets=len(data_analyzer.df) if data_analyzer and data_analyzer.df is not None else 0
    )


@app.post("/chat", response_model=ChatResponse)
async def chat(message: ChatMessage):
    """
    Process a chat message and return AI response with optional charts.
    """
    if not agent:
        raise HTTPException(status_code=500, detail="Agent not initialized")
    
    try:
        logger.info(f"Processing message: {message.message}")
        
        result = agent.query(message.message)
        
        return ChatResponse(
            response=result["answer"],
            charts=result["charts"]
        )
    except Exception as e:
        logger.error(f"Error processing chat message: {str(e)}")
        raise HTTPException(status_code=500, detail=str(e))


@app.get("/api/summary")
async def get_summary():
    """Get overall data summary."""
    if not data_analyzer:
        raise HTTPException(status_code=500, detail="Data analyzer not initialized")
    
    return data_analyzer.get_data_summary()


@app.get("/api/sprint/{sprint_id}")
async def get_sprint(sprint_id: str):
    """Get specific sprint summary."""
    if not data_analyzer:
        raise HTTPException(status_code=500, detail="Data analyzer not initialized")
    
    return data_analyzer.get_sprint_summary(sprint_id)


@app.get("/api/team-performance")
async def get_team_performance():
    """Get team performance metrics."""
    if not data_analyzer:
        raise HTTPException(status_code=500, detail="Data analyzer not initialized")
    
    return data_analyzer.get_team_performance()


@app.get("/api/bugs")
async def get_bugs():
    """Get bug analysis."""
    if not data_analyzer:
        raise HTTPException(status_code=500, detail="Data analyzer not initialized")
    
    return data_analyzer.get_bug_analysis()


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        "app:app",
        host=settings.app_host,
        port=settings.app_port,
        reload=settings.debug
    )
